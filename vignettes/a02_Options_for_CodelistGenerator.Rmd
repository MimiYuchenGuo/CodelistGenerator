---
title: "02 Options for CodelistGenerator"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{02_Options_for_CodelistGenerator}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Mock vocabulary database
```{r,  message=FALSE, warning=FALSE}
  library(DBI)
  library(RSQLite)
  library(dplyr)
  library(here)
  library(kableExtra)
  library(CodelistGenerator)
```

LetÂ´s say we have a mock vocabulary database with these hypothethical concepts and relationships.

```{r,echo=FALSE}
knitr::include_graphics("mock_db_fig1.png")
```

```{r,  message=FALSE, warning=FALSE,echo=FALSE}
concept<-data.frame(concept_id=1:7,
                    concept_name=c("Musculoskeletal disorder",
                                   "Osteoarthrosis",
                                   "Arthritis",
                                   "Osteoarthritis of knee",
                                   "Osteoarthritis of hip",
                                   "Degenerative arthropathy",
                                   "Knee osteoarthritis"),
                    domain_id="Condition",
                    vocabulary_id=c(rep("SNOMED",5),
                                    rep("Read", 2)),
                    standard_concept=c(rep("S",5),
                                    rep(NA, 2)),
           concept_code=NA)
concept_ancestor<-bind_rows(
data.frame(ancestor_concept_id=1,
                             descendant_concept_id=2,
                             min_levels_of_separation=1,
                             max_levels_of_separation=1),
data.frame(ancestor_concept_id=1,
                             descendant_concept_id=3,
                             min_levels_of_separation=1,
                             max_levels_of_separation=1),
data.frame(ancestor_concept_id=1,
                             descendant_concept_id=4,
                             min_levels_of_separation=2,
                             max_levels_of_separation=2),
data.frame(ancestor_concept_id=1,
                             descendant_concept_id=5,
                             min_levels_of_separation=2,
                             max_levels_of_separation=2),
data.frame(ancestor_concept_id=3,
                             descendant_concept_id=4,
                             min_levels_of_separation=1,
                             max_levels_of_separation=1),
data.frame(ancestor_concept_id=3,
                             descendant_concept_id=5,
                             min_levels_of_separation=1,
                             max_levels_of_separation=1))
concept_synonym<-data.frame(concept_id=3,
                            concept_synonym_name="Osteoarthrosis")
concept_relationship <- bind_rows(
data.frame(concept_id_1=2,
           concept_id_2=6,
           relationship_id="Mapped from"),
data.frame(concept_id_1=4,
           concept_id_2=7,
           relationship_id="Mapped from"))
db <- dbConnect(RSQLite::SQLite(), ":memory:")
dbWithTransaction(db, {
  dbWriteTable(db, "concept", concept, overwrite =TRUE)
})
dbWithTransaction(db, {
  dbWriteTable(db, "concept_ancestor", concept_ancestor, overwrite =TRUE)
})
dbWithTransaction(db, {
  dbWriteTable(db, "concept_synonym", concept_synonym, overwrite =TRUE)
})
dbWithTransaction(db, {
  dbWriteTable(db, "concept_relationship", concept_relationship, overwrite =TRUE)
})
```

## Search for exact keyword match 
```{r,echo=FALSE}
knitr::include_graphics("mock_db_fig2.png")
```

To find "Musculoskeletal disorder" we can search for that like so 
```{r}
codes<-get_candidate_codes(
    keywords = "Musculoskeletal disorder",
    domains="Condition",
    include_descendants = FALSE,
    db = db,
    vocabulary_database_schema = "main"
  )

kable(codes)
```

## Search for exact keyword match and add descendants
```{r,echo=FALSE}
knitr::include_graphics("mock_db_fig7.png")
```

To find that code and its descendants we can set include_descendants to TRUE.
```{r}
kable(get_candidate_codes(
    keywords = "Musculoskeletal disorder",
    domains="Condition",
    include_descendants = TRUE,
    db = db,
    vocabulary_database_schema = "main"
  ))
```

## Search for exact keyword match with multiple words
```{r}
knitr::include_graphics("mock_db_fig4.png")
```

We can also find concepts with multiple words even if they are in a different order. For example, a search for "Knee osteoarthritis" will pick up "Osteoarthritis of knee".

```{r}
codes<-get_candidate_codes(
    keywords = "Knee osteoarthritis",
    fuzzy_match = TRUE,
    domains="Condition",
    include_descendants = TRUE,
    db = db,
    vocabulary_database_schema = "main"
  )

kable(codes)
```

## Exclusions

```{r}
knitr::include_graphics("mock_db_fig5.png")
```

We can also exlude specific terms 

```{r}
codes<-get_candidate_codes(
    keywords = "arthritis",
    exclude = "Hip osteoarthritis",
    domains="Condition",
    db = db,
    vocabulary_database_schema = "main"
  )

kable(codes)
```

# searching via synonym
```{r}
knitr::include_graphics("mock_db_fig6.png")
```

We can also pick up codes based on their synonyms. In this case "Arthritis" (which gets identified first) has a synonym of "Osteoarthrosis", and based on this synonym we can also include the "Osteoarthrosis" concept.

```{r}
codes<-get_candidate_codes(
    keywords = "arthritis",
    domains="Condition",
    search_synonyms = TRUE,
    db = db,
    vocabulary_database_schema = "main"
  )

kable(codes)
```

# fuzzy search
```{r}
knitr::include_graphics("mock_db_fig6.png")
```

We could have also picked up "Osteoarthrosis" by doing fuzzy matching which allows for some differences in spelling.

```{r}
codes<-get_candidate_codes(
    keywords = "arthritis",
    domains="Condition",
    fuzzy_match = TRUE,
    db = db,
    vocabulary_database_schema = "main"
  )

kable(codes)
```

# Search via source
Or we could have also picked up "Osteoarthrosis" by searching via source.

```{r}
codes<-get_candidate_codes(
    keywords = c("arthritis","arthropathy"),
    domains="Condition",
    search_source = TRUE,
    db = db,
    vocabulary_database_schema = "main"
  )

kable(codes)
```

# Include non-standard concepts

```{r}
knitr::include_graphics("mock_db_fig8.png")
```

We can also include non-standard codes in our results like so

```{r}
codes<-get_candidate_codes(
    keywords = c("Musculoskeletal disorder",
                 "arthritis",
                 "arthropathy",
                 "arthrosis"),
    domains="Condition",
    standard_concept= c("Standard", "Non-standard"),
    db = db,
    vocabulary_database_schema = "main"
  )

kable(codes)
```






# With complete vocabulary database



```{r,  message=FALSE, warning=FALSE,echo=FALSE}
library(here)
library(readr)
library(DBI)
library(RSQLite)
library(here)
library(dplyr)
library(stringr)
library(DT)
library(kableExtra)
library(CodelistGenerator)
```


## Creating a codelist for osteoarthritis
For this example we are going to generate a candidate codelist for osteoarthritis, looking at the impact of alternative search strategies.

## Set up 
```{r, eval=FALSE}
library(DBI)
library(RPostgres)
```

```{r, eval=FALSE}
# postgres database connection details
server_dbi<-Sys.getenv("server")
user<-Sys.getenv("user")
password<- Sys.getenv("password")
port<-Sys.getenv("port")
host<-Sys.getenv("host")

db <- dbConnect(RPostgres::Postgres(),
                dbname = server_dbi,
                port = port,
                host = host,
                user = user,
                password = password)

# name of vocabulary schema
vocabulary_database_schema<-"vocabulary"
```


## Search strategies
### Condition domain, without searching synonyms, without fuzzy match, with exclusions, without including descendants or ancestor
```{r,  message=FALSE, warning=FALSE,echo=FALSE}
oa_codes1<-readRDS(here("vignettes","options_data_01.RData"))
```

To start we will search for "osteoarthritis", while excluding "post-infection" and "post-traumatic", but without searching synonyms, without searching via source codes, without fuzzy matching, and without including descendants or the direct ancestor of the included concepts.

```{r, eval=FALSE}
oa_codes1<-get_candidate_codes(keywords="osteoarthritis",
                    domains="Condition",
                    search_synonyms = FALSE,
                    search_source=FALSE,
                    fuzzy_match = FALSE,
                    exclude = c("post-infection",
                                "post-traumatic"),
                    include_descendants = FALSE,
                    include_ancestor = FALSE,
                    db=db,
                    vocabulary_database_schema =  vocabulary_database_schema)
```

What is the candidate codelist?
```{r,  message=FALSE, warning=FALSE }  
datatable(oa_codes1,
          options = list(pageLength = 10,
                         lengthMenu = c(10, 20,250)))

```


### Including descendants
```{r,  message=FALSE, warning=FALSE,echo=FALSE}
oa_codes2<-readRDS(here("vignettes","options_data_02.RData"))
```

Now we will also include the descendants of included concepts.
```{r, eval=FALSE}
oa_codes2<-get_candidate_codes(keywords="osteoarthritis",
                    domains="Condition",
                    search_synonyms = FALSE,
                    search_source=FALSE,
                    fuzzy_match = FALSE,
                    exclude = c("post-infection",
                                "post-traumatic"),
                    include_descendants = TRUE,
                    include_ancestor = FALSE,
                    db=db,
                    vocabulary_database_schema =  vocabulary_database_schema)
```

What new codes do we pick up?
```{r,  message=FALSE, warning=FALSE }  
new_codes_1_2<-bind_rows(oa_codes1, oa_codes2) %>% 
  group_by(concept_id) %>% 
  mutate(seq=length(concept_name)) %>%
  filter(seq==1)
datatable(new_codes_1_2,
          rownames=FALSE,
          options = list(
  pageLength = 10,
  lengthMenu = c(10, 20,50)
))

```

### Including observation domain
```{r,  message=FALSE, warning=FALSE,echo=FALSE}
oa_codes3<-readRDS(here("vignettes","options_data_03.RData"))
```

Now we will search the observation domain as well as the condition domain.
```{r, eval=FALSE}
oa_codes3<-get_candidate_codes(keywords="osteoarthritis",
                    domains=c("Condition","Observation"),
                    search_synonyms = FALSE,
                    search_source=FALSE,
                    fuzzy_match = FALSE,
                    exclude = c("post-infection",
                                "post-traumatic"),
                    include_descendants = FALSE,
                    include_ancestor = FALSE,
                    db=db,
                    vocabulary_database_schema =  vocabulary_database_schema)
```

What new codes do we pick up?
```{r,  message=FALSE, warning=FALSE }  
new_codes_1_3<-bind_rows(oa_codes1, oa_codes3) %>% 
  group_by(concept_id) %>% 
  mutate(seq=length(concept_name)) %>%
  filter(seq==1)
datatable(new_codes_1_3,
          rownames=FALSE,
          options = list(
  pageLength = 10,
  lengthMenu = c(10, 20,50)
))
```

### Search synonyms
```{r,  message=FALSE, warning=FALSE,echo=FALSE}
oa_codes4<-readRDS(here("vignettes","options_data_04.RData"))
```

Now we will search the concept synonym table to identify concepts to include.
```{r, eval=FALSE}
oa_codes4<-get_candidate_codes(keywords="osteoarthritis",
                    domains="Condition",
                    search_synonyms = TRUE,
                    search_source=FALSE,
                    fuzzy_match = FALSE,
                    exclude = c("post-infection",
                                "post-traumatic"),
                    include_descendants = FALSE,
                    include_ancestor = FALSE,
                    db=db,
                    vocabulary_database_schema =  vocabulary_database_schema)
```

What new codes do we pick up?
```{r,  message=FALSE, warning=FALSE }  
new_codes_1_4<-bind_rows(oa_codes1, oa_codes4) %>% 
  group_by(concept_id) %>% 
  mutate(seq=length(concept_name)) %>%
  filter(seq==1)
datatable(new_codes_1_4,
          rownames=FALSE,
          options = list(
  pageLength = 10,
  lengthMenu = c(10, 20,50)
))
```

### Search via source
```{r,  message=FALSE, warning=FALSE,echo=FALSE}
oa_codes5<-readRDS(here("vignettes","options_data_04.RData"))
```

Now we will search the concept synonym table to identify concepts to include.
```{r, eval=FALSE}
oa_codes5<-get_candidate_codes(keywords="osteoarthritis",
                    domains="Condition",
                    search_synonyms = FALSE,
                    search_source=TRUE,
                    fuzzy_match = FALSE,
                    exclude = c("post-infection",
                                "post-traumatic"),
                    include_descendants = FALSE,
                    include_ancestor = FALSE,
                    db=db,
                    vocabulary_database_schema =  vocabulary_database_schema)
```

What new codes do we pick up?
```{r,  message=FALSE, warning=FALSE }  
new_codes_1_5<-bind_rows(oa_codes1, oa_codes5) %>% 
  group_by(concept_id) %>% 
  mutate(seq=length(concept_name)) %>%
  filter(seq==1)
datatable(new_codes_1_5,
          rownames=FALSE,
          options = list(
  pageLength = 10,
  lengthMenu = c(10, 20,50)
))
```

### Using a fuzzy search
```{r,  message=FALSE, warning=FALSE,echo=FALSE}
oa_codes6<-readRDS(here("vignettes","options_data_05.RData"))
```

Now we will use an approximate search. See https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/agrep for further details (as this is what is running under the hood). Note, using the defaults of 0.1 for for substitutions, deletions, and insertions.
```{r, eval=FALSE}
oa_codes6<-get_candidate_codes(keywords="osteoarthritis",
                    domains="Condition",
                    search_synonyms = FALSE,
                    search_source=FALSE,
                    fuzzy_match = TRUE,
                    max_distance_substitutions = 0.1,
                    max_distance_deletions = 0.1,
                    max_distance_insertions = 0.1,
                    exclude = c("post-infection",
                                "post-traumatic"),
                    include_descendants = FALSE,
                    include_ancestor = FALSE,
                    db=db,
                    vocabulary_database_schema =  vocabulary_database_schema)
```

What new codes do we pick up?
```{r,  message=FALSE, warning=FALSE }  
new_codes_1_6<-bind_rows(oa_codes1, oa_codes6) %>% 
  group_by(concept_id) %>% 
  mutate(seq=length(concept_name)) %>%
  filter(seq==1)
datatable(new_codes_1_6,
          rownames=FALSE,
          options = list(
  pageLength = 10,
  lengthMenu = c(10, 20,50)
))
```

### Using a more generous fuzzy search
```{r,  message=FALSE, warning=FALSE,echo=FALSE}
oa_codes7<-readRDS(here("vignettes","options_data_06.RData"))
```

Here we widen the approximate searching, increasing the maximum distance allowed for a match to 0.2 for substitutions, deletions, and insertions.
```{r, eval=FALSE}
oa_codes7<-get_candidate_codes(keywords="osteoarthritis",
                    domains="Condition",
                    search_synonyms = FALSE,
                    search_source=FALSE,
                    fuzzy_match = TRUE,
                    max_distance_substitutions = 0.2,
                    max_distance_deletions = 0.2,
                    max_distance_insertions = 0.2,
                    exclude = c("post-infection",
                                "post-traumatic"),
                    include_descendants = FALSE,
                    include_ancestor = FALSE,
                    db=db,
                    vocabulary_database_schema =  vocabulary_database_schema)
```

What new codes do we pick up?
```{r,  message=FALSE, warning=FALSE }  
new_codes_1_7<-bind_rows(oa_codes1, oa_codes7) %>% 
  group_by(concept_id) %>% 
  mutate(seq=length(concept_name)) %>%
  filter(seq==1)
datatable(new_codes_1_7,
          rownames=FALSE,
          options = list(
  pageLength = 10,
  lengthMenu = c(10, 20,50)
))
```

### Include ancestor
```{r,  message=FALSE, warning=FALSE,echo=FALSE}
oa_codes8<-readRDS(here("vignettes","options_data_07.RData"))
```

Now we include the direct ancestor of included terms.
```{r, eval=FALSE}
oa_codes8<-get_candidate_codes(keywords="osteoarthritis",
                    domains="Condition",
                    search_synonyms = FALSE,
                    search_source=FALSE,
                    fuzzy_match = FALSE,
                    max_distance_substitutions = 0.1,
                    max_distance_deletions = 0.1,
                    max_distance_insertions = 0.1,
                    exclude = c("post-infection",
                                "post-traumatic"),
                    include_descendants = FALSE,
                    include_ancestor = TRUE,
                    db=db,
                    vocabulary_database_schema =  vocabulary_database_schema)
```

What new codes do we pick up?
```{r,  message=FALSE, warning=FALSE }  
new_codes_1_8<-bind_rows(oa_codes1, oa_codes8) %>% 
  group_by(concept_id) %>% 
  mutate(seq=length(concept_name)) %>%
  filter(seq==1)
datatable(new_codes_1_8,
          rownames=FALSE,
          options = list(
  pageLength = 10,
  lengthMenu = c(10, 20,50)
))
```

